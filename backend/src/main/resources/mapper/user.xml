<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
    
<mapper namespace="com.ssafy.cooking.dao.UserDao">
 
	<select id="isDupEmail" parameterType="string" resultType="int">
		select count(user_id) from User where email = #{email}
	</select>
	
	<select id="isDupNickname" parameterType="string" resultType="int">
		select count(user_id) from User where nickname = #{nickname}
	</select>
	
	<insert id="signup" parameterType="User">
		insert into User(
						password
						, nickname
						, email
						<if test="profile_image != null and profile_image != ''">
							, profile_image
						</if>
						<if test="intro != null and intro != ''">
							, intro
						</if>
						, image_name
						, create_date
					) values(
						#{password}
						, #{nickname}
						, #{email}
						<if test="profile_image != null and profile_image != ''">
							, #{profile_image}
						</if>
						<if test="intro != null and intro != ''">
							, #{intro}
						</if>
						, #{image_name}
						, now()
					)
	</insert>
	
	<select id="signin" resultType="User">
		SELECT user_id, email, nickname, profile_image, intro
		FROM User
		WHERE email = #{email} AND password = #{password}
	</select>
	
	<delete id="delete">
		DELETE 
		FROM User 
		WHERE user_id = #{uid}
	</delete>
	
	<select id="getUser" resultType="User">
		SELECT user_id, email, nickname, profile_image, intro, image_name, start_page, create_date
		FROM User
		WHERE user_id = #{uid}
	</select>
	
	<update id="reviseUser" parameterType="User">
		UPDATE User
		SET nickname = #{nickname}
			, profile_image = #{profile_image}
			, intro = #{intro}
			, image_name = #{image_name}
			<if test="password != null and password != ''">
				, password = #{password}
			</if>
			, update_date = now()
			, start_page = #{start_page}
		WHERE user_id= #{user_id}
	</update>
	
	<select id="getFollowers" resultType="User">
		SELECT u.user_id, u.id, u.email, u.nickname, u.profile_image, u.intro
		FROM User u
		JOIN Following f ON u.user_id = f.from_user
		WHERE u.user_id = #{uid};
	</select>
	
	<select id="getCommnets" resultType="Comment">
		SELECT c.recipe_id, c.description, c.create_date
		FROM Comments c
		JOIN User u ON u.user_id = c.comm_user
		WHERE u.user_id = #{uid};
	</select>
	
	<select id="checkPassword" parameterType="string" resultType="int">
		SELECT count(user_id)
		FROM User
		WHERE user_id = #{uid} AND password = #{password}
	</select>
	
	
	<update id="updatePasswordByEmail" parameterType="string">
		UPDATE User
		SET password = #{password}
		WHERE email = #{email}	
	</update>
	
	
	<select id="isConfirmedEmail" parameterType="string" resultType="int">
		SELECT count(email)
		FROM Email_confirm
		WHERE email = #{email} AND now() &lt; expire_date
	</select>
	
	<insert id="insertEmailConfirm" parameterType="string">
		INSERT into Email_confirm
			VALUES(#{email}, #{code}, now(), date_add(now(), interval 3 minute))
	</insert>
	
	<select id="checkConfirmCode" parameterType="EmailConfirm" resultType="int">
		SELECT count(email)
		FROM Email_confirm
		WHERE email = #{email} 
			AND code = #{code} 
			AND now() &lt; expire_date
	</select>
	
	<delete id="deleteConfirmCode" parameterType="string">
		DELETE from Email_confirm
		WHERE email = #{email}
	</delete>
	
	<select id="selectNextUserId" resultType="int">
		SELECT AUTO_INCREMENT
		FROM information_schema.tables
		WHERE table_name = 'User'
		AND table_schema = DATABASE()
	</select>
</mapper>
